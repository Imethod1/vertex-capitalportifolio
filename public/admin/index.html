<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Vertex Capital Admin</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #f5f5f5;
      }
      #debug {
        background: white;
        border: 2px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      .debug-line {
        margin: 5px 0;
        padding: 3px;
        border-left: 3px solid #ccc;
        padding-left: 10px;
      }
      .debug-line.error {
        color: red;
        border-left-color: red;
        background: #ffe0e0;
      }
      .debug-line.success {
        color: green;
        border-left-color: green;
        background: #e0ffe0;
      }
      .debug-line.info {
        color: blue;
        border-left-color: blue;
      }
      .debug-line.warning {
        color: orange;
        border-left-color: orange;
        background: #fff5e0;
      }
      #app {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h2>Vertex Capital Admin - Debugging</h2>
    <div id="debug"></div>
    <div id="app"></div>

    <script>
      // Debug logging system
      const debugDiv = document.getElementById('debug');
      const logs = [];

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] ${message}`;
        logs.push({ message: entry, type });
        
        const line = document.createElement('div');
        line.className = `debug-line ${type}`;
        line.textContent = entry;
        debugDiv.appendChild(line);
        debugDiv.scrollTop = debugDiv.scrollHeight;
        
        console.log(`[${type.toUpperCase()}]`, message);
      }

      // Global error handler
      window.addEventListener('error', (e) => {
        addLog(`ERROR: ${e.message} (${e.filename}:${e.lineno})`, 'error');
      });

      window.addEventListener('unhandledrejection', (e) => {
        addLog(`PROMISE REJECTION: ${e.reason}`, 'error');
      });

      // Start debugging
      addLog('Page loaded, starting Decap CMS initialization...', 'info');
      addLog(`Current URL: ${window.location.href}`, 'info');

      // Monitor Decap CMS loading
      addLog('Waiting for Decap CMS script to load...', 'warning');

      window.addEventListener('load', () => {
        addLog('Window load event fired', 'info');
        
        if (window.CMS) {
          addLog('✓ Decap CMS object detected!', 'success');
        } else {
          addLog('✗ Decap CMS object NOT found', 'error');
          addLog('Checking window properties...', 'warning');
          const keys = Object.keys(window).filter(k => k.includes('CMS') || k.includes('cms'));
          if (keys.length > 0) {
            addLog(`Found related properties: ${keys.join(', ')}`, 'info');
          }
        }
      });

      // Check script loading
      const scriptCheck = setInterval(() => {imal config.yml - Provides a valid fallback if Decap CMS tries to load from file
      Updated initialization - Uses CMS.registerConfig() which is the proper v3.0.0 API for injecting full config
        if (window.CMS) {
          addLog('✓ CMS loaded via script tag', 'success');
          clearInterval(scriptCheck);
        }
      }, 500);

      // Timeout after 10 seconds
      setTimeout(() => {
        if (!window.CMS) {
          addLog('✗ CMS did not load within 10 seconds', 'error');
          clearInterval(scriptCheck);
        }
      }, 10000);
    </script>
    
    <!-- Load Decap CMS from jsDelivr CDN (stable) -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.0.0/dist/decap-cms.min.js"></script>
    
    <script>
      // Load JSON config and initialize Decap CMS
      async function initializeCMS() {
        if (!window.CMS) {
          setTimeout(initializeCMS, 100);
          return;
        }

        try {
          addLog('Loading config from /admin/config.json...', 'info');
          
          // Fetch JSON config
          const response = await fetch('/admin/config.json');
          if (!response.ok) {
            throw new Error(`Failed to load config: ${response.status}`);
          }
          
          const config = await response.json();
          addLog(`✓ Config loaded successfully (${Object.keys(config).length} properties)`, 'success');
          
          // Validate config has all required properties
          const required = ['backend', 'media_folder', 'public_folder', 'media_library', 'collections'];
          const missing = required.filter(prop => !config[prop]);
          
          if (missing.length > 0) {
            throw new Error(`Missing required properties: ${missing.join(', ')}`);
          }
          
          addLog(`Registering ${config.collections.length} collections...`, 'info');
          config.collections.forEach(col => {
            addLog(`  - ${col.name} (${col.files?.length || 0} files)`, 'info');
          });
          
          // Register config with Decap CMS
          window.CMS.init({ config });
          addLog('✓ Decap CMS initialized with JSON config!', 'success');
          
        } catch (err) {
          addLog(`✗ Init error: ${err.message}`, 'error');
          console.error('Full error:', err);
        }
      }

      // Start after CMS library loads
      window.addEventListener('load', initializeCMS);
    </script>
  </body>
</html>
