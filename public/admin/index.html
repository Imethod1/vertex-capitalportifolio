<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Vertex Capital Admin</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #f5f5f5;
      }
      #debug {
        background: white;
        border: 2px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      .debug-line {
        margin: 5px 0;
        padding: 3px;
        border-left: 3px solid #ccc;
        padding-left: 10px;
      }
      .debug-line.error {
        color: red;
        border-left-color: red;
        background: #ffe0e0;
      }
      .debug-line.success {
        color: green;
        border-left-color: green;
        background: #e0ffe0;
      }
      .debug-line.info {
        color: blue;
        border-left-color: blue;
      }
      .debug-line.warning {
        color: orange;
        border-left-color: orange;
        background: #fff5e0;
      }
      #app {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h2>Vertex Capital Admin - Debugging</h2>
    <div id="debug"></div>
    <div id="app"></div>

    <script>
      // Debug logging system
      const debugDiv = document.getElementById('debug');
      const logs = [];

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] ${message}`;
        logs.push({ message: entry, type });
        
        const line = document.createElement('div');
        line.className = `debug-line ${type}`;
        line.textContent = entry;
        debugDiv.appendChild(line);
        debugDiv.scrollTop = debugDiv.scrollHeight;
        
        console.log(`[${type.toUpperCase()}]`, message);
      }

      // Global error handler
      window.addEventListener('error', (e) => {
        addLog(`ERROR: ${e.message} (${e.filename}:${e.lineno})`, 'error');
      });

      window.addEventListener('unhandledrejection', (e) => {
        addLog(`PROMISE REJECTION: ${e.reason}`, 'error');
      });

      // Start debugging
      addLog('Page loaded, starting Decap CMS debug...', 'info');
      addLog(`Current URL: ${window.location.href}`, 'info');
      addLog(`Looking for config at: /admin/config.yml`, 'info');

      // Check if config file exists
      fetch('/admin/config.yml')
        .then(response => {
          if (response.ok) {
            addLog(`✓ Config file found (status: ${response.status})`, 'success');
            return response.text();
          } else {
            addLog(`✗ Config file not found (status: ${response.status})`, 'error');
            return null;
          }
        })
        .then(configText => {
          if (configText) {
            addLog(`✓ Config loaded (${configText.length} bytes)`, 'success');
            addLog(`Config preview: ${configText.substring(0, 100)}...`, 'info');
          }
        })
        .catch(err => {
          addLog(`✗ Config fetch error: ${err.message}`, 'error');
        });

      // Monitor Decap CMS loading
      addLog('Waiting for Decap CMS script to load...', 'warning');

      window.addEventListener('load', () => {
        addLog('Window load event fired', 'info');
        
        if (window.CMS) {
          addLog('✓ Decap CMS object detected!', 'success');
        } else {
          addLog('✗ Decap CMS object NOT found', 'error');
          addLog('Checking window properties...', 'warning');
          const keys = Object.keys(window).filter(k => k.includes('CMS') || k.includes('cms'));
          if (keys.length > 0) {
            addLog(`Found related properties: ${keys.join(', ')}`, 'info');
          }
        }
      });

      // Check script loading
      const scriptCheck = setInterval(() => {
        if (window.CMS) {
          addLog('✓ CMS loaded via script tag', 'success');
          clearInterval(scriptCheck);
        }
      }, 500);

      // Timeout after 10 seconds
      setTimeout(() => {
        if (!window.CMS) {
          addLog('✗ CMS did not load within 10 seconds', 'error');
          clearInterval(scriptCheck);
        }
      }, 10000);
    </script>
    
    <!-- Load YAML parser -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.js"></script>
    
    <!-- Load Decap CMS from jsDelivr CDN (stable) -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.0.0/dist/decap-cms.min.js"></script>
    
    <script>
      // Initialize CMS with full config object
      function initializeCMS() {
        if (!window.CMS) {
          setTimeout(initializeCMS, 100);
          return;
        }

        addLog('CMS ready, building config object...', 'success');
        
        // Full config object with all required properties
        const cmsConfig = {
          backend: {
            name: 'github',
            repo: 'Imethod1/vertex-capitalportifolio',
            branch: 'main',
            auth_endpoint: 'https://vertex-capitalportfolio.vercel.app/api/auth',
            base_url: 'https://vertex-capitalportfolio.vercel.app',
            app_id: 'Ov23lifj7lCto8d0EHYT'
          },
          media_folder: 'public/images',
          public_folder: '/images',
          collections: [
            {
              name: 'portfolio',
              label: 'Portfolio Data',
              files: [{
                file: 'src/data/portfolio.json',
                label: 'Portfolio Data',
                name: 'portfolio',
                format: 'json',
                fields: [
                  { label: 'Date', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD' },
                  { label: 'Total Value (TZS)', name: 'totalValue', widget: 'number' },
                  {
                    label: 'Allocations',
                    name: 'allocations',
                    widget: 'list',
                    fields: [
                      { label: 'Asset Class', name: 'allocationClass', widget: 'select', options: ['Fixed Income', 'Domestic Equities', 'Regional (EAC/SADC) Equities', 'Cash & Cash Equivalents'] },
                      { label: 'Target %', name: 'targetPercent', widget: 'number' },
                      { label: 'Current %', name: 'currentPercent', widget: 'number' }
                    ]
                  }
                ]
              }]
            },
            {
              name: 'risk_metrics',
              label: 'Risk Metrics',
              files: [{
                file: 'src/data/riskMetrics.json',
                label: 'Risk Metrics',
                name: 'risk_metrics',
                format: 'json',
                fields: [{
                  label: 'Metrics',
                  name: 'metrics',
                  widget: 'list',
                  fields: [
                    { label: 'Metric Name', name: 'metricName', widget: 'string' },
                    { label: 'Current Value', name: 'currentValue', widget: 'string' },
                    { label: 'Status', name: 'status', widget: 'select', options: ['Compliant', 'Warning', 'Breach'] }
                  ]
                }]
              }]
            },
            {
              name: 'settings',
              label: 'Portfolio Settings',
              files: [{
                file: 'src/data/settings.json',
                label: 'Settings',
                name: 'settings',
                format: 'json',
                fields: [
                  { label: 'Portfolio Name', name: 'portfolioName', widget: 'string' },
                  { label: 'Portfolio Manager', name: 'portfolioManager', widget: 'string' },
                  { label: 'Last Updated', name: 'lastUpdated', widget: 'datetime', format: 'YYYY-MM-DD HH:mm' },
                  { label: 'Benchmark Index', name: 'benchmark', widget: 'string' },
                  { label: 'YTD Performance %', name: 'ytdPerformance', widget: 'number' }
                ]
              }]
            }
          ]
        };

        try {
          addLog(`Collections defined: ${cmsConfig.collections.map(c => c.name).join(', ')}`, 'info');
          window.CMS.init({ config: cmsConfig });
          addLog('✓ CMS initialized successfully!', 'success');
        } catch (err) {
          addLog(`✗ CMS init error: ${err.message}`, 'error');
          console.error(err);
        }
      }

      // Start initialization after page loads
      window.addEventListener('load', initializeCMS);
    </script>
  </body>
</html>
